#!/usr/bin/env bash

# Simple wallpaper selector for rofi
# Lists wallpapers from ~/Pictures/Wallpapers and sets them with swww + matugen

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"

# Check if wallpaper directory exists
if [[ ! -d "$WALLPAPER_DIR" ]]; then
    echo "No wallpaper directory found"
    echo "Please create $WALLPAPER_DIR and add images"
    exit 0
fi

# If no argument provided, list wallpapers for rofi
if [[ $# -eq 0 ]]; then
    # List all image files
    find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) -exec basename {} \; 2>/dev/null | sort
    exit 0
fi

# Set the selected wallpaper
selected_wallpaper="$1"
wallpaper_path="$WALLPAPER_DIR/$selected_wallpaper"

if [[ ! -f "$wallpaper_path" ]]; then
    notify-send "Error" "Wallpaper not found: $selected_wallpaper"
    exit 1
fi

# Set wallpaper with swww
swww img "$wallpaper_path" --transition-type wipe --transition-duration 1

# Generate theme with matugen
echo "🎨 Generating theme colors..."
matugen image "$wallpaper_path" --variant dark --json-format hex

# Generate colors for all components manually to ensure they're created
echo "  • Generating component colors..."

# Waybar colors
if [[ -f "templates/waybar.css" ]]; then
    matugen image "$wallpaper_path" --variant dark --json-format hex -t templates/waybar.css > dotfiles/waybar/colors.css
fi

# Kitty colors
if [[ -f "templates/kitty.conf" ]]; then
    matugen image "$wallpaper_path" --variant dark --json-format hex -t templates/kitty.conf > dotfiles/kitty/colors.conf
fi

# Dunst colors
if [[ -f "templates/dunst.conf" ]]; then
    matugen image "$wallpaper_path" --variant dark --json-format hex -t templates/dunst.conf > dotfiles/dunst/colors.conf
fi

# Hyprland colors
if [[ -f "templates/hyprland.conf" ]]; then
    matugen image "$wallpaper_path" --variant dark --json-format hex -t templates/hyprland.conf > dotfiles/hypr/colors.conf
fi

# Rofi colors
if [[ -f "templates/rofi.rasi" ]]; then
    matugen image "$wallpaper_path" --variant dark --json-format hex -t templates/rofi.rasi > dotfiles/rofi/colors.rasi
fi

# Reload applications to pick up new colors
echo "🔄 Reloading applications with new theme..."

# Check for running window manager and reload
if pgrep -x "Hyprland" > /dev/null; then
    echo "  • Reloading Hyprland configuration..."
    hyprctl reload
elif pgrep -x "niri" > /dev/null; then
    echo "  • Niri configuration reloaded automatically."
else
    echo "  ⚠️  Neither Hyprland nor Niri are running. Skipping WM reload."
fi

# Restart Waybar (dual bars: top + bottom)
echo "  • Terminating all Waybar instances..."
killall -9 waybar 2>/dev/null || true
pkill -9 waybar 2>/dev/null || true

# Force wait to ensure complete termination
sleep 2

# Double-check and force kill any remaining waybar processes
while pgrep waybar > /dev/null; do
    echo "  • Force killing remaining waybar processes..."
    pkill -9 waybar 2>/dev/null || true
    killall -9 waybar 2>/dev/null || true
    sleep 1
done

echo "  • Starting top Waybar..."
nohup waybar -c ~/nixos-config/dotfiles/waybar/config -s ~/nixos-config/dotfiles/waybar/style.css > /tmp/waybar-top.log 2>&1 &

echo "  • Starting bottom Waybar (system monitoring)..."
nohup waybar -c ~/nixos-config/dotfiles/waybar/config-bottom -s ~/nixos-config/dotfiles/waybar/style-bottom.css > /tmp/waybar-bottom.log 2>&1 &

# Give waybar time to start
sleep 1

# Force waybar to reload CSS by sending SIGUSR2 signal
echo "  • Forcing waybar CSS reload..."
pkill -SIGUSR2 waybar 2>/dev/null || true

# Restart Dunst
if pgrep -x dunst > /dev/null; then
    echo "  • Restarting Dunst..."
    pkill dunst
    sleep 0.5
fi
echo "  • Starting Dunst..."
dunst > /dev/null 2>&1 &

# Reload Kitty configurations
echo "  • Reloading Kitty configurations..."
killall -USR1 kitty 2>/dev/null || echo "    (No kitty instances to reload)"

# Refresh GTK applications
echo "  • Refreshing GTK theme cache..."
if command -v gsettings >/dev/null 2>&1; then
    current_theme=$(gsettings get org.gnome.desktop.interface gtk-theme 2>/dev/null || echo "'Adwaita-dark'")
    gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita' 2>/dev/null || true
    sleep 0.1
    gsettings set org.gnome.desktop.interface gtk-theme "${current_theme//\'}" 2>/dev/null || true
    echo "    ✓ GTK theme refreshed"
fi

# Show notification
notify-send "Wallpaper Changed" "$selected_wallpaper" -i "$wallpaper_path"
