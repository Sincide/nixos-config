#!/usr/bin/env bash

# Simple wallpaper selector for rofi
# Lists wallpapers from ~/Pictures/Wallpapers and sets them with swww + matugen

WALLPAPER_DIR="$HOME/Pictures/Wallpapers"

# Check if wallpaper directory exists
if [[ ! -d "$WALLPAPER_DIR" ]]; then
    echo "No wallpaper directory found"
    echo "Please create $WALLPAPER_DIR and add images"
    exit 0
fi

# If no argument provided, list wallpapers for rofi
if [[ $# -eq 0 ]]; then
    # List all image files
    find "$WALLPAPER_DIR" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" -o -iname "*.gif" \) -exec basename {} \; 2>/dev/null | sort
    exit 0
fi

# Set the selected wallpaper
selected_wallpaper="$1"
wallpaper_path="$WALLPAPER_DIR/$selected_wallpaper"

if [[ ! -f "$wallpaper_path" ]]; then
    notify-send "Error" "Wallpaper not found: $selected_wallpaper"
    exit 1
fi

# Set wallpaper with swww
swww img "$wallpaper_path" --transition-type wipe --transition-duration 1

# Generate theme with matugen
matugen image "$wallpaper_path" --variant dark --json-format hex

# Reload applications to pick up new colors
echo "ðŸ”„ Reloading applications with new theme..."

# Check for running window manager and reload
if pgrep -x "Hyprland" > /dev/null; then
    echo "  â€¢ Reloading Hyprland configuration..."
    hyprctl reload
elif pgrep -x "niri" > /dev/null; then
    echo "  â€¢ Niri configuration reloaded automatically."
else
    echo "  âš ï¸  Neither Hyprland nor Niri are running. Skipping WM reload."
fi

# Restart Waybar (dual bars: top + bottom)
if pgrep -x waybar > /dev/null; then
    echo "  â€¢ Restarting Waybar instances..."
    pkill waybar
    sleep 0.5
fi
echo "  â€¢ Starting top Waybar..."
waybar > /dev/null 2>&1 &
echo "  â€¢ Starting bottom Waybar (system monitoring)..."
waybar -c ~/.config/nixos-config/dotfiles/waybar/config-bottom -s ~/.config/nixos-config/dotfiles/waybar/style-bottom.css > /dev/null 2>&1 &

# Restart Dunst
if pgrep -x dunst > /dev/null; then
    echo "  â€¢ Restarting Dunst..."
    pkill dunst
    sleep 0.5
fi
echo "  â€¢ Starting Dunst..."
dunst > /dev/null 2>&1 &

# Reload Kitty configurations
echo "  â€¢ Reloading Kitty configurations..."
killall -USR1 kitty 2>/dev/null || echo "    (No kitty instances to reload)"

# Refresh GTK applications
echo "  â€¢ Refreshing GTK theme cache..."
if command -v gsettings >/dev/null 2>&1; then
    current_theme=$(gsettings get org.gnome.desktop.interface gtk-theme 2>/dev/null || echo "'Adwaita-dark'")
    gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita' 2>/dev/null || true
    sleep 0.1
    gsettings set org.gnome.desktop.interface gtk-theme "${current_theme//\'}" 2>/dev/null || true
    echo "    âœ“ GTK theme refreshed"
fi

# Show notification
notify-send "Wallpaper Changed" "$selected_wallpaper" -i "$wallpaper_path"
